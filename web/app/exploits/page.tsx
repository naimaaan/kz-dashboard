'use client'

import { useEffect, useRef, useState } from 'react'
import {
	AlertTriangle,
	Check,
	Clock,
	FlaskConical,
	Loader2,
	Play,
	RefreshCw,
	Search,
	Shield,
	Target,
	Terminal,
	X,
} from 'lucide-react'
import { toast } from 'sonner'
import { SharedLayout } from '@/components/shared-layout'
import { Button } from '@/components/ui/button'
import { Badge } from '@/components/ui/badge'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { IconButton } from '@/components/ui/icon-button'
import { Input } from '@/components/ui/input'
import { Skeleton } from '@/components/ui/skeleton'
import { cn } from '@/lib/utils'

interface ExploitArg {
	name: string
	default: string
}

interface MitreAttack {
	tactic: string
	technique: string
}

interface ExploitItem {
	id: string
	name: string
	service: string
	script: string
	cve: string
	severity: string
	mitreAttack: MitreAttack
	minProfile: string
	description: string
	args: ExploitArg[]
}

interface RunResult {
	runId: string
	exploitId: string
	status: 'running' | 'success' | 'error' | 'timeout'
	output: string
	exitCode: number | null
	startedAt: string
	finishedAt: string | null
	durationMs: number | null
}

const severityStyles: Record<string, string> = {
	critical:
		'border-red-600/40 bg-red-600/15 text-red-700 dark:text-red-300',
	high: 'border-orange-500/40 bg-orange-500/15 text-orange-700 dark:text-orange-300',
	medium:
		'border-amber-500/40 bg-amber-500/15 text-amber-700 dark:text-amber-300',
	low: 'border-blue-500/40 bg-blue-500/15 text-blue-700 dark:text-blue-300',
}

const statusStyles: Record<string, string> = {
	running:
		'border-blue-500/40 bg-blue-500/15 text-blue-700 dark:text-blue-300',
	success:
		'border-emerald-500/40 bg-emerald-500/15 text-emerald-700 dark:text-emerald-300',
	error:
		'border-rose-500/40 bg-rose-500/15 text-rose-700 dark:text-rose-300',
	timeout:
		'border-amber-500/40 bg-amber-500/15 text-amber-700 dark:text-amber-300',
}

const StatusIcon = ({ status }: { status: string }) => {
	if (status === 'running')
		return <Loader2 className='h-3.5 w-3.5 animate-spin' />
	if (status === 'success') return <Check className='h-3.5 w-3.5' />
	if (status === 'error') return <X className='h-3.5 w-3.5' />
	if (status === 'timeout') return <Clock className='h-3.5 w-3.5' />
	return null
}

export default function ExploitsPage() {
	const [exploits, setExploits] = useState<ExploitItem[]>([])
	const [isLoading, setIsLoading] = useState(true)
	const [searchQuery, setSearchQuery] = useState('')
	const [selectedExploit, setSelectedExploit] = useState<ExploitItem | null>(
		null,
	)
	const [isRunning, setIsRunning] = useState(false)
	const [currentRun, setCurrentRun] = useState<RunResult | null>(null)
	const [runHistory, setRunHistory] = useState<RunResult[]>([])
	const outputRef = useRef<HTMLDivElement | null>(null)

	const fetchExploits = async (showLoader = false) => {
		if (showLoader) setIsLoading(true)
		try {
			const response = await fetch('/api/exploits', { cache: 'no-store' })
			if (!response.ok) throw new Error('Failed to load exploits')
			const data = (await response.json()) as ExploitItem[]
			setExploits(data)
		} catch {
			toast.error('Failed to load exploits catalog')
		} finally {
			setIsLoading(false)
		}
	}

	const runExploit = async (exploit: ExploitItem) => {
		setIsRunning(true)
		setCurrentRun(null)

		const defaultArgs: Record<string, string> = {}
		for (const arg of exploit.args) {
			defaultArgs[arg.name] = arg.default
		}

		try {
			const response = await fetch(`/api/exploits/${exploit.id}/run`, {
				method: 'POST',
				headers: { 'content-type': 'application/json' },
				body: JSON.stringify({ args: defaultArgs }),
			})

			if (!response.ok) {
				const err = await response.json().catch(() => ({ message: 'Unknown error' }))
				throw new Error(err.message ?? 'Failed to run exploit')
			}

			const result = (await response.json()) as RunResult
			setCurrentRun(result)
			setRunHistory(prev => [result, ...prev].slice(0, 20))

			if (result.status === 'success') {
				toast.success(`${exploit.name}: completed successfully`)
			} else if (result.status === 'error') {
				toast.error(`${exploit.name}: finished with errors`)
			} else if (result.status === 'timeout') {
				toast.error(`${exploit.name}: execution timed out`)
			}
		} catch (error) {
			toast.error(
				error instanceof Error ? error.message : 'Failed to run exploit',
			)
		} finally {
			setIsRunning(false)
		}
	}

	useEffect(() => {
		void fetchExploits(true)
	}, [])

	useEffect(() => {
		if (outputRef.current) {
			outputRef.current.scrollTop = outputRef.current.scrollHeight
		}
	}, [currentRun])

	const normalizedQuery = searchQuery.trim().toLowerCase()
	const filteredExploits = exploits.filter(
		e =>
			normalizedQuery.length === 0 ||
			e.name.toLowerCase().includes(normalizedQuery) ||
			e.service.toLowerCase().includes(normalizedQuery) ||
			e.cve.toLowerCase().includes(normalizedQuery) ||
			e.mitreAttack.technique.toLowerCase().includes(normalizedQuery),
	)

	const groupedByService = filteredExploits.reduce<
		Record<string, ExploitItem[]>
	>((acc, e) => {
		const key = e.service
		if (!acc[key]) acc[key] = []
		acc[key].push(e)
		return acc
	}, {})

	const serviceGroups = Object.entries(groupedByService).sort(([a], [b]) =>
		a.localeCompare(b),
	)

	const catalogSidebar = (
		<>
			<p className='mb-2 text-xs font-medium uppercase tracking-widest text-muted-foreground'>
				Exploit Stats
			</p>
			<div className='space-y-2 text-sm'>
				<div className='flex items-center justify-between px-3 py-1'>
					<span className='text-muted-foreground'>Total Exploits</span>
					<Badge variant='secondary'>{exploits.length}</Badge>
				</div>
				<div className='flex items-center justify-between px-3 py-1'>
					<span className='text-muted-foreground'>Services</span>
					<Badge variant='secondary'>
						{new Set(exploits.map(e => e.service)).size}
					</Badge>
				</div>
				<div className='flex items-center justify-between px-3 py-1'>
					<span className='text-muted-foreground'>Runs</span>
					<Badge variant='secondary'>{runHistory.length}</Badge>
				</div>
			</div>
			{runHistory.length > 0 && (
				<div className='mt-4'>
					<p className='mb-2 text-xs font-medium uppercase tracking-widest text-muted-foreground'>
						Recent Runs
					</p>
					<div className='max-h-48 space-y-1 overflow-y-auto'>
						{runHistory.slice(0, 8).map(run => (
							<button
								key={run.runId}
								type='button'
								onClick={() => setCurrentRun(run)}
								className='flex w-full items-center gap-2 rounded-md px-3 py-1.5 text-xs text-muted-foreground transition-colors hover:bg-accent hover:text-accent-foreground'
							>
								<StatusIcon status={run.status} />
								<span className='truncate'>
									{exploits.find(e => e.id === run.exploitId)?.name ??
										run.exploitId}
								</span>
							</button>
						))}
					</div>
				</div>
			)}
		</>
	)

	return (
		<SharedLayout sidebar={catalogSidebar}>
			<div className='space-y-6'>
				<div className='flex flex-wrap items-center justify-between gap-3'>
					<div>
						<h2 className='text-lg font-semibold tracking-tight'>
							Exploit Runner
						</h2>
						<p className='text-sm text-muted-foreground'>
							Browse and execute PoC exploits against vulnerable services.
							MITRE ATT&CK mapped.
						</p>
					</div>

					<IconButton
						variant='outline'
						size='sm'
						aria-label='Refresh exploits'
						onClick={() => void fetchExploits()}
						disabled={isLoading}
						icon={
							<RefreshCw
								className={cn('h-4 w-4', isLoading && 'animate-spin')}
							/>
						}
					/>
				</div>

				<div className='grid gap-6 lg:grid-cols-[1fr_420px]'>
					{/* Left: Exploit Catalog */}
					<div className='space-y-4'>
						<div className='relative'>
							<Search className='absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground' />
							<Input
								placeholder='Search by name, service, CVE, or ATT&CK technique...'
								value={searchQuery}
								onChange={e => setSearchQuery(e.target.value)}
								className='pl-10'
							/>
						</div>

						{isLoading ? (
							<div className='space-y-4'>
								{Array.from({ length: 3 }).map((_, i) => (
									<Card
										key={`skel-${i}`}
										className='border-zinc-200/60 dark:border-zinc-800'
									>
										<CardHeader>
											<Skeleton className='h-5 w-32' />
										</CardHeader>
										<CardContent className='space-y-2'>
											<Skeleton className='h-16 w-full' />
											<Skeleton className='h-16 w-full' />
										</CardContent>
									</Card>
								))}
							</div>
						) : filteredExploits.length === 0 ? (
							<Card className='border-zinc-200/60 dark:border-zinc-800'>
								<CardContent className='pt-6'>
									<p className='text-sm text-muted-foreground'>
										No exploits match the current search.
									</p>
								</CardContent>
							</Card>
						) : (
							<div className='space-y-6'>
								{serviceGroups.map(([service, serviceExploits]) => (
									<div key={service}>
										<div className='mb-3 flex items-center gap-2'>
											<Target className='h-4 w-4 text-muted-foreground' />
											<h3 className='text-sm font-semibold capitalize'>
												{service}
											</h3>
											<Badge variant='secondary' className='text-[11px]'>
												{serviceExploits.length}
											</Badge>
										</div>

										<div className='space-y-2'>
											{serviceExploits.map(exploit => {
												const isSelected =
													selectedExploit?.id === exploit.id
												const sevStyle =
													severityStyles[exploit.severity] ??
													severityStyles.medium

												return (
													<Card
														key={exploit.id}
														className={cn(
															'cursor-pointer border-zinc-200/60 transition hover:border-zinc-300 hover:shadow-sm dark:border-zinc-800 dark:hover:border-zinc-700',
															isSelected && 'ring-2 ring-primary',
														)}
														onClick={() => setSelectedExploit(exploit)}
													>
														<CardContent className='py-4'>
															<div className='flex items-start justify-between gap-3'>
																<div className='min-w-0 flex-1'>
																	<div className='flex items-center gap-2'>
																		<FlaskConical className='h-4 w-4 shrink-0 text-muted-foreground' />
																		<p className='truncate text-sm font-medium'>
																			{exploit.name}
																		</p>
																	</div>
																	<p className='mt-1 line-clamp-2 text-xs text-muted-foreground'>
																		{exploit.description}
																	</p>
																</div>
																<Button
																	size='sm'
																	variant='outline'
																	className='shrink-0'
																	disabled={isRunning}
																	onClick={e => {
																		e.stopPropagation()
																		setSelectedExploit(exploit)
																		void runExploit(exploit)
																	}}
																>
																	{isRunning &&
																	selectedExploit?.id === exploit.id ? (
																		<Loader2 className='mr-1 h-3.5 w-3.5 animate-spin' />
																	) : (
																		<Play className='mr-1 h-3.5 w-3.5' />
																	)}
																	Run
																</Button>
															</div>

															<div className='mt-3 flex flex-wrap gap-1.5'>
																<Badge
																	variant='secondary'
																	className={sevStyle}
																>
																	{exploit.severity}
																</Badge>
																{exploit.cve && (
																	<Badge
																		variant='secondary'
																		className='font-mono text-[11px]'
																	>
																		<AlertTriangle className='mr-1 h-3 w-3' />
																		{exploit.cve}
																	</Badge>
																)}
																<Badge
																	variant='secondary'
																	className='border-violet-500/30 bg-violet-500/10 text-[11px] text-violet-700 dark:text-violet-300'
																>
																	<Shield className='mr-1 h-3 w-3' />
																	{exploit.mitreAttack.technique}
																</Badge>
															</div>
														</CardContent>
													</Card>
												)
											})}
										</div>
									</div>
								))}
							</div>
						)}
					</div>

					{/* Right: Detail + Output Panel */}
					<div className='space-y-4'>
						{selectedExploit && (
							<Card className='border-zinc-200/60 dark:border-zinc-800'>
								<CardHeader className='pb-3'>
									<CardTitle className='text-base'>
										{selectedExploit.name}
									</CardTitle>
									<p className='text-xs text-muted-foreground'>
										{selectedExploit.script} Â·{' '}
										min profile: {selectedExploit.minProfile}
									</p>
								</CardHeader>
								<CardContent className='space-y-3'>
									<p className='text-sm text-muted-foreground'>
										{selectedExploit.description}
									</p>

									<div className='space-y-1'>
										<p className='text-xs font-medium text-muted-foreground'>
											MITRE ATT&CK
										</p>
										<div className='flex flex-wrap gap-1.5'>
											<Badge
												variant='secondary'
												className='border-violet-500/30 bg-violet-500/10 text-violet-700 dark:text-violet-300'
											>
												{selectedExploit.mitreAttack.tactic}
											</Badge>
											<Badge
												variant='secondary'
												className='border-violet-500/30 bg-violet-500/10 text-violet-700 dark:text-violet-300'
											>
												{selectedExploit.mitreAttack.technique}
											</Badge>
										</div>
									</div>

									{selectedExploit.args.length > 0 && (
										<div className='space-y-1'>
											<p className='text-xs font-medium text-muted-foreground'>
												Arguments (using defaults)
											</p>
											<div className='space-y-1'>
												{selectedExploit.args.map(arg => (
													<div
														key={arg.name}
														className='flex items-center gap-2 rounded border border-zinc-200/60 bg-zinc-50 px-3 py-1.5 text-xs dark:border-zinc-800 dark:bg-zinc-900/50'
													>
														<code className='font-medium'>{arg.name}</code>
														<span className='text-muted-foreground'>
															= {arg.default}
														</span>
													</div>
												))}
											</div>
										</div>
									)}

									<Button
										className='w-full'
										disabled={isRunning}
										onClick={() => void runExploit(selectedExploit)}
									>
										{isRunning ? (
											<>
												<Loader2 className='mr-2 h-4 w-4 animate-spin' />
												Running...
											</>
										) : (
											<>
												<Play className='mr-2 h-4 w-4' />
												Run Exploit
											</>
										)}
									</Button>
								</CardContent>
							</Card>
						)}

						{/* Output Terminal */}
						<Card className='overflow-hidden border-zinc-200/60 dark:border-zinc-800'>
							<CardHeader className='bg-[#0b0f14] pb-2'>
								<div className='flex items-center justify-between'>
									<CardTitle className='flex items-center gap-2 text-sm text-zinc-300'>
										<Terminal className='h-4 w-4' />
										Output
									</CardTitle>
									{currentRun && (
										<Badge
											variant='secondary'
											className={
												statusStyles[currentRun.status] ??
												statusStyles.error
											}
										>
											<StatusIcon status={currentRun.status} />
											<span className='ml-1'>{currentRun.status}</span>
											{currentRun.durationMs !== null && (
												<span className='ml-1'>
													({(currentRun.durationMs / 1000).toFixed(1)}s)
												</span>
											)}
										</Badge>
									)}
								</div>
							</CardHeader>
							<div
								ref={outputRef}
								className='h-80 overflow-auto bg-[#0b0f14] px-4 pb-4 font-mono'
							>
								{currentRun ? (
									<pre className='whitespace-pre-wrap text-xs leading-relaxed text-zinc-200'>
										{currentRun.output || 'Waiting for output...'}
									</pre>
								) : (
									<p className='pt-2 text-xs text-zinc-500'>
										Select an exploit and click Run to see output here.
									</p>
								)}
							</div>
						</Card>
					</div>
				</div>
			</div>
		</SharedLayout>
	)
}
