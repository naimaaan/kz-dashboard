#!/usr/bin/env python3
"""
GitLab ExifTool RCE (CVE-2021-22205) PoC
Unauthenticated RCE via DjVu file upload in GitLab CE <= 13.10.2
"""
import sys
import urllib.request
import urllib.error

def exploit(target_url: str):
    print(f"[*] Target: {target_url}")
    print(f"[*] CVE-2021-22205 - GitLab ExifTool RCE")
    print()

    print("[*] Checking GitLab accessibility...")
    try:
        req = urllib.request.Request(f"{target_url}/users/sign_in", method='GET')
        resp = urllib.request.urlopen(req, timeout=15)
        body = resp.read().decode('utf-8', errors='replace')

        if 'GitLab' in body:
            print("[+] GitLab login page accessible")
        else:
            print("[!] Page accessible but may not be GitLab")
    except Exception as e:
        print(f"[-] Cannot reach GitLab: {e}")
        print("[!] GitLab may need several minutes to initialize")
        return

    print()
    print("[*] CVE-2021-22205 requires a crafted DjVu image with embedded")
    print("    ExifTool metadata payload. This PoC verifies target accessibility.")
    print()
    print("[*] For full exploitation, use:")
    print("    - Metasploit: exploit/multi/http/gitlab_exif_rce")
    print("    - nuclei: cves/2021/CVE-2021-22205.yaml")
    print()
    print("[+] Target appears vulnerable if running GitLab CE <= 13.10.2")

if __name__ == '__main__':
    url = sys.argv[1] if len(sys.argv) > 1 else "http://localhost:9031"
    exploit(url)
